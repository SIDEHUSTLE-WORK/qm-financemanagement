// Prisma Schema for QM Finance System
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== SCHOOL & USERS ====================

model School {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  email     String?
  logoPath  String?  @map("logo_path")
  motto     String?
  poBox     String?  @map("po_box")
  settings  Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users             User[]
  students          Student[]
  classes           Class[]
  academicYears     AcademicYear[]
  academicTerms     AcademicTerm[]
  incomeCategories  IncomeCategory[]
  expenseCategories ExpenseCategory[]
  income            Income[]
  expenses          Expense[]
  reports           Report[]
  auditLogs         AuditLog[]
  settings_kv       Setting[]
  smsLogs           SmsLog[]
  budgets           Budget[]
  roles             Role[]
  paymentPlans      PaymentPlan[]
  installments      Installment[]

  @@map("schools")
}

model User {
  id                 String    @id @default(uuid())
  schoolId           String    @map("school_id")
  username           String
  passwordHash       String    @map("password_hash")
  fullName           String    @map("full_name")
  email              String?
  phone              String?
  userRole           UserRole  @default(viewer) @map("user_role")
  roleId             String?   @map("role_id")
  permissions        Json      @default("{}")
  isActive           Boolean   @default(true) @map("is_active")
  mustChangePassword Boolean   @default(false) @map("must_change_password")
  lastLogin          DateTime? @map("last_login")
  loginAttempts      Int       @default(0) @map("login_attempts")
  lockedUntil        DateTime? @map("locked_until")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  school           School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  role             Role?          @relation(fields: [roleId], references: [id])
  refreshTokens    RefreshToken[]
  incomeReceived   Income[]       @relation("ReceivedBy")
  incomeVoided     Income[]       @relation("VoidedBy")
  expensesPaid     Expense[]      @relation("PaidBy")
  expensesApproved Expense[]      @relation("ApprovedBy")
  expensesVoided   Expense[]      @relation("ExpenseVoidedBy")
  reportsGenerated Report[]
  auditLogs        AuditLog[]
  classTeacher     Class[]

  @@unique([schoolId, username])
  @@map("users")
}

enum UserRole {
  super_admin
  director
  bursar
  accountant
  teacher
  viewer
}

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  permissions Json     @default("{}")
  schoolId    String   @map("school_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  users  User[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("roles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ==================== ACADEMIC ====================

model AcademicYear {
  id        String   @id @default(uuid())
  schoolId  String   @map("school_id")
  year      Int
  name      String
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  isCurrent Boolean  @default(false) @map("is_current")
  createdAt DateTime @default(now()) @map("created_at")

  school School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  terms  AcademicTerm[]

  @@unique([schoolId, year])
  @@map("academic_years")
}

model AcademicTerm {
  id             String   @id @default(uuid())
  schoolId       String   @map("school_id")
  academicYearId String   @map("academic_year_id")
  name           String
  termNumber     Int      @map("term_number")
  startDate      DateTime @map("start_date")
  endDate        DateTime @map("end_date")
  isCurrent      Boolean  @default(false) @map("is_current")
  createdAt      DateTime @default(now()) @map("created_at")

  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  feeStructures   FeeStructure[]
  studentBalances StudentBalance[]
  income          Income[]

  @@unique([academicYearId, termNumber])
  @@map("academic_terms")
}

model Class {
  id             String   @id @default(uuid())
  schoolId       String   @map("school_id")
  name           String
  level          Int
  section        String?
  classTeacherId String?  @map("class_teacher_id")
  capacity       Int?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classTeacher  User?          @relation(fields: [classTeacherId], references: [id])
  students      Student[]
  feeStructures FeeStructure[]

  @@unique([schoolId, name, section])
  @@map("classes")
}

// ==================== STUDENTS ====================

model Student {
  id             String    @id @default(uuid())
  schoolId       String    @map("school_id")
  studentNumber  String    @map("student_number")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  otherNames     String?   @map("other_names")
  dateOfBirth    DateTime? @map("date_of_birth")
  gender         Gender?
  classId        String?   @map("class_id")
  parentName     String?   @map("parent_name")
  parentPhone    String?   @map("parent_phone")
  parentPhoneAlt String?   @map("parent_phone_alt")
  parentEmail    String?   @map("parent_email")
  address        String?
  photoPath      String?   @map("photo_path")
  admissionDate  DateTime  @default(now()) @map("admission_date")
  previousSchool String?   @map("previous_school")
  medicalInfo    String?   @map("medical_info")
  notes          String?
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  school       School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class        Class?              @relation(fields: [classId], references: [id])
  balances     StudentBalance[]
  income       Income[]
  paymentPlans StudentPaymentPlan[]

  @@unique([schoolId, studentNumber])
  @@map("students")
}

enum Gender {
  male
  female
  other
}

model FeeStructure {
  id          String   @id @default(uuid())
  schoolId    String   @map("school_id")
  termId      String   @map("term_id")
  classId     String   @map("class_id")
  feeType     String   @map("fee_type")
  description String?
  amount      Decimal  @db.Decimal(12, 2)
  isMandatory Boolean  @default(true) @map("is_mandatory")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  term  AcademicTerm @relation(fields: [termId], references: [id], onDelete: Cascade)
  class Class        @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([termId, classId, feeType])
  @@map("fee_structures")
}

model StudentBalance {
  id              String   @id @default(uuid())
  studentId       String   @map("student_id")
  termId          String   @map("term_id")
  totalFees       Decimal  @default(0) @map("total_fees") @db.Decimal(12, 2)
  amountPaid      Decimal  @default(0) @map("amount_paid") @db.Decimal(12, 2)
  previousBalance Decimal  @default(0) @map("previous_balance") @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  student Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  term    AcademicTerm @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([studentId, termId])
  @@map("student_balances")
}

// ==================== INCOME ====================

model IncomeCategory {
  id           String   @id @default(uuid())
  schoolId     String   @map("school_id")
  name         String
  description  String?
  isFeeRelated Boolean  @default(false) @map("is_fee_related")
  isActive     Boolean  @default(true) @map("is_active")
  color        String   @default("#10B981")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  school School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  income Income[]

  @@unique([schoolId, name])
  @@map("income_categories")
}

model Income {
  id             String        @id @default(uuid())
  schoolId       String        @map("school_id")
  receiptNumber  String        @map("receipt_number")
  date           DateTime      @db.Date
  categoryId     String?       @map("category_id")
  studentId      String?       @map("student_id")
  termId         String?       @map("term_id")
  description    String
  amount         Decimal       @db.Decimal(12, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  mobileMoneyRef String?       @map("mobile_money_ref")
  bankRef        String?       @map("bank_ref")
  schoolPayRef   String?       @map("school_pay_ref")
  chequeNumber   String?       @map("cheque_number")
  receivedById   String?       @map("received_by")
  notes          String?
  isVoided       Boolean       @default(false) @map("is_voided")
  voidedById     String?       @map("voided_by")
  voidedAt       DateTime?     @map("voided_at")
  voidReason     String?       @map("void_reason")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  school     School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  category   IncomeCategory? @relation(fields: [categoryId], references: [id])
  student    Student?        @relation(fields: [studentId], references: [id])
  term       AcademicTerm?   @relation(fields: [termId], references: [id])
  receivedBy User?           @relation("ReceivedBy", fields: [receivedById], references: [id])
  voidedBy   User?           @relation("VoidedBy", fields: [voidedById], references: [id])

  @@unique([schoolId, receiptNumber])
  @@map("income")
}

enum PaymentMethod {
  cash
  mobile_money
  school_pay
  bank_transfer
  cheque
}

// ==================== EXPENSES ====================

model ExpenseCategory {
  id          String   @id @default(uuid())
  schoolId    String   @map("school_id")
  name        String
  description String?
  budgetLimit Decimal? @map("budget_limit") @db.Decimal(12, 2)
  isActive    Boolean  @default(true) @map("is_active")
  color       String   @default("#EF4444")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  school   School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  expenses Expense[]

  @@unique([schoolId, name])
  @@map("expense_categories")
}

model Expense {
  id              String         @id @default(uuid())
  schoolId        String         @map("school_id")
  date            DateTime       @db.Date
  categoryId      String?        @map("category_id")
  description     String
  amount          Decimal        @db.Decimal(12, 2)
  vendor          String?
  receiptPath     String?        @map("receipt_path")
  approvedById    String?        @map("approved_by")
  paidById        String?        @map("paid_by")
  paymentMethod   PaymentMethod? @map("payment_method")
  referenceNumber String?        @map("reference_number")
  notes           String?
  isVoided        Boolean        @default(false) @map("is_voided")
  voidedById      String?        @map("voided_by")
  voidedAt        DateTime?      @map("voided_at")
  voidReason      String?        @map("void_reason")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  school     School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  category   ExpenseCategory? @relation(fields: [categoryId], references: [id])
  approvedBy User?            @relation("ApprovedBy", fields: [approvedById], references: [id])
  paidBy     User?            @relation("PaidBy", fields: [paidById], references: [id])
  voidedBy   User?            @relation("ExpenseVoidedBy", fields: [voidedById], references: [id])

  @@map("expenses")
}

// ==================== PAYMENT PLANS ====================

model PaymentPlan {
  id           String   @id @default(uuid())
  name         String
  totalAmount  Decimal  @map("total_amount") @db.Decimal(12, 2)
  installments Int
  termId       String?  @map("term_id")
  isActive     Boolean  @default(true) @map("is_active")
  schoolId     String   @map("school_id")
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  school       School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentPlans StudentPaymentPlan[]

  @@index([schoolId])
  @@map("payment_plans")
}

model StudentPaymentPlan {
  id            String   @id @default(uuid())
  studentId     String   @map("student_id")
  paymentPlanId String   @map("payment_plan_id")
  totalAmount   Decimal  @map("total_amount") @db.Decimal(12, 2)
  status        String   @default("active") // active, completed, cancelled
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  paymentPlan  PaymentPlan   @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)
  installments Installment[]

  @@unique([studentId, paymentPlanId])
  @@map("student_payment_plans")
}

model Installment {
  id                   String    @id @default(uuid())
  studentPaymentPlanId String    @map("student_payment_plan_id")
  installmentNumber    Int       @map("installment_number")
  amount               Decimal   @db.Decimal(12, 2)
  dueDate              DateTime  @map("due_date") @db.Date
  paidAmount           Decimal   @default(0) @map("paid_amount") @db.Decimal(12, 2)
  paidDate             DateTime? @map("paid_date")
  status               String    @default("pending") // pending, partial, paid, overdue
  reminderSent         Boolean   @default(false) @map("reminder_sent")
  reminderSentAt       DateTime? @map("reminder_sent_at")
  schoolId             String    @map("school_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  studentPaymentPlan StudentPaymentPlan @relation(fields: [studentPaymentPlanId], references: [id], onDelete: Cascade)
  school             School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([status])
  @@index([dueDate])
  @@map("installments")
}

// ==================== REPORTS ====================

model Report {
  id            String    @id @default(uuid())
  schoolId      String    @map("school_id")
  reportType    String    @map("report_type")
  title         String
  dateFrom      DateTime? @map("date_from") @db.Date
  dateTo        DateTime? @map("date_to") @db.Date
  generatedById String?   @map("generated_by")
  parameters    Json?
  summary       Json?
  filePath      String?   @map("file_path")
  fileSize      Int?      @map("file_size")
  isArchived    Boolean   @default(false) @map("is_archived")
  createdAt     DateTime  @default(now()) @map("created_at")

  school      School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  generatedBy User?  @relation(fields: [generatedById], references: [id])

  @@map("reports")
}

// ==================== AUDIT ====================

model AuditLog {
  id          String   @id @default(uuid())
  schoolId    String?  @map("school_id")
  userId      String?  @map("user_id")
  userName    String?  @map("user_name")
  userRole    String?  @map("user_role")
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id")
  description String?
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  school School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// ==================== SETTINGS ====================

model Setting {
  id        String   @id @default(uuid())
  schoolId  String   @map("school_id")
  key       String
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, key])
  @@map("settings")
}

// ==================== SMS ====================

model SmsLog {
  id          String   @id @default(uuid())
  phone       String
  message     String   @db.Text
  studentId   String?  @map("student_id")
  studentName String?  @map("student_name")
  status      String
  cost        Int      @default(0)
  response    String?  @db.Text
  sentBy      String   @map("sent_by")
  schoolId    String   @map("school_id")
  createdAt   DateTime @default(now()) @map("created_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("sms_logs")
}

// ==================== BUDGET ====================

model Budget {
  id        String   @id @default(uuid())
  category  String
  amount    Decimal  @db.Decimal(15, 2)
  period    String
  month     Int?
  year      Int
  termId    String?  @map("term_id")
  spent     Decimal  @default(0) @db.Decimal(15, 2)
  schoolId  String   @map("school_id")
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, category, period, year, month])
  @@index([schoolId, year])
  @@map("budgets")
}
